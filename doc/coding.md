# Coding

## Local environment variables

We have a `.env` file which contains all environment variables needed to run the app locally. If you need to override one (or more) of these variables, you'll have to use the `.env.override` file.

## Seed data

During the project setup, fake data will be seeded in the database to ease the onboarding.

Collaborator accounts with email `admin@myfoodrepo.org`, `manager@myfoodrepo.org` and `annotator@myfoodrepo.org` with password `MyFoodRepoPassword` will be created allowing you to sign in with various roles.

Run `rails db:seed` to seed the DB manually.

Beware that you need an AWS IAM user with the right permissions to seed data from seed files hosted in the `myfoodrepo2-db-seeds` bucket. The credentials of this user can be set in the `.env.override` file (AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY env variables).

## What do I have to take care of after switching to another branch?

* If `Dockerfile` is changed: [Build the Docker image locally](#build-the-docker-image-locally)
* If `Gemfile.lock` is changed: `docker compose run --rm app bundle install`
* If `yarn.lock` is changed: `docker compose run --rm app yarn install`

## Accessing your local server from the internet

To show work in progress to a remote colleague, communicate with an external service or to test the behaviour on a mobile phone or for mobile development, it is sometimes useful to have an external url. There are several solutions, here we'll describe how to do it with [Ngrok](https://ngrok.com).

To install `ngrok`:

* Sign Up on the [Ngrok website](https://dashboard.ngrok.com/signup) (the free account is enough)
* Follow the [Setup & Installation guide](https://dashboard.ngrok.com/get-started/setup) (for installation, `brew install ngrok` also works)

To start the tunnel, run: `ngrok http 80`. Under "Forwarding" you'll see the https proxy you can use.

## Remote debugging

The `app` Docker container opens the port `12345` for Ruby remote debugging. Use the following command on the host to connect:

```bash
rdbg -A 12345
```

## Frontend

We use [yarn](https://yarnpkg.com) as package manager and [esbuild](https://esbuild.github.io) as the module bundler.

### Styleguide

We use [ViewComponent previews](https://viewcomponent.org/guide/previews.html) to create the preview of our components. All components are shown on [/styleguide](0.0.0.0/styleguide). This page is provided by a gem named [lookbook](https://github.com/allmarkedup/lookbook) which simply use and group the previews created by the `view_component` gem.

### Icons

On MFR, we use the [Phosphor Icons](https://phosphoricons.com). With Vanilla JS, the only recommended way to [import them](https://github.com/phosphor-icons/phosphor-icons#getting-started) is through a CDN (no straightforward way to do it through a package manager). To ensure that be the file distributed by the CDN has not been manipulated midway, we use the [Subresource Integrity (SRI)](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity) leveraging an `integrity` attribute in the loading html `script` tag. This attribute can be generated by downloading the JS file (`index.js`) from the CDN and run the following command:

`cat index.js | openssl dgst -sha384 -binary | openssl base64 -A`

The resulting hash should be prefixed with `sha384-` and added as the value of the `integrity` attribute of the `script` tag.

## Model instances creation

In order to prevent the cluttering of models with callbacks prone to side-effects, we often use [FormObjects](https://www.google.com/search?q=rails+formobject+pattern) in controllers. Be aware that simply calling `#create` or `#save` on models is often not enough to run the callbacks.

## Code linting

We use [Rubocop](https://github.com/rubocop/rubocop) to lint the Ruby code. You can run the linter simply with `bundle exec Rubocop`. The configuration file is `.rubocop.yml`.

We use [erb-lint](https://github.com/Shopify/erb-lint) to lint `erb` files. You can run the linter with `bundle exec erblint --lint-all --enable-all-linters`. The configuration file is `.erb-lint.yml`.

We use [eslint](https://github.com/Shopify/erb-lint) to lint javascript files. You can run the linter with `yarn run eslint`.  The configuration file is `.eslintrc.js`.

These three linters are also run by the CI.

## Background jobs

We use Sidekiq to run background jobs. To see those, you have to be logged as an admin collaborator and visit the [Sidekiq page](http://0.0.0.0/sidekiq)
