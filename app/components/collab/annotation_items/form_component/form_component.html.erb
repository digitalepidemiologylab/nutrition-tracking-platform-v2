<%
  data = {
    controller: "drag",
    action: "dragstart->drag#dragStart dragover->drag#dragOver dragenter->drag#dragEnter drop->drag#dragDrop dragend->drag#dragEnd dragleave->drag#dragLeave",
    resource_id: @annotation_item.id,
    url: collab_annotation_item_sort_path(@annotation_item, locale: I18n.locale),
    parent: "annotation_items"
  }
%>
<%=
  turbo_frame_tag(
    dom_id(@annotation_item),
    class: "draggable",
    draggable: true,
    data: data
  ) do
%>
  <%=
    form_for(
      [:collab, @annotation_item],
      url: collab_annotation_item_path(@annotation_item, locale: I18n.locale),
      builder: AppFormBuilder,
      # As we have multiple times the same form on the page we need to add a namespace
      namespace: @position
    ) do |f|
  %>
    <%=
      tag.div(
        class: "mb-2 group annotation-item annotation-item-#{@color_index} border-l-8 border-contrast-#{@color_index} bg-contrast-#{@color_index} bg-opacity-20 text-gray-600 px-3 py-2 hover:bg-opacity-30 hover:text-gray-800 flex items-center text-sm font-medium leading-tight rounded-md selected:text-gray-800 selected:bg-opacity-50 selected:hover:bg-opacity-50 selected:hover:text-gray-800",
        data: {
          id: @annotation_item.id,
          "polygon-set-url": collab_annotation_item_polygon_set_path(@annotation_item, locale: I18n.locale),
          controller: "annotation-items--form",
          action: "click->annotation#selectItem onItemAdd->annotation-items--form#handleChange",
          "annotation-target": "form"
        }.merge(@additional_data)
      ) do
    %>
      <div class="w-full">
        <%= f.hidden_field :id %>
        <%= f.hidden_field :disable_kcal_in_range_validation %>
        <% if @food %>
          <div class="w-full" data-controller="foods--select">
            <div class="flex flex-row flex-1 justify-start items-center food_id" data-controller="foods--select">
              <%=
                f.select(
                  :food_id,
                  @options,
                  {required: true},
                  disabled: @disabled,
                  class: "grow mt-1 block rounded-md text-sm focus:outline-none focus:ring-brand focus:border-brand
                  rounded-md cursor-pointer",
                  data: {
                    "foods--select_target": "foodSelect",
                    preload: @food_set.present? ? "false" : "focus",
                    url: collab_foods_url(format: :json, food_list_ids: @food_lists.pluck(:id)),
                    action: "focus->annotation#selectItem change->annotation-items--form#handleChange"
                  }
                )
              %>
              <%= link_to(t("collab.annotation_items.form_component.see_food"), collab_food_path(id: f.object.food.id), data: {turbo_frame: "_top"}, class: "text-brand ml-2 hover:underline") %>
            </div>
            <%= f.error_text(:food_id) %>
          </div>
        <% else %>
          <div class="w-full">
            <div class="flex justify-start">
              <%= f.text_field :barcode, class: "grow mt-1 block w-1/2 pl-3 py-2 text-sm border-gray-300 focus:outline-none focus:ring-brand focus:border-brand rounded-md #{@disabled_classes}", placeholder: "#{t("activerecord.models.product", count: 1)} #{t("activerecord.attributes.product.barcode")}", disabled: @disabled, data: {action: "change->annotation-items--form#handleChange focus->annotation#selectItem"} %>
              <% if f.object.product&.persisted? %>
                <p class="mt-3 ml-2 text-sm text-gray-500">
                  <%=
                    link_to(
                      f.object.product&.name.presence || t("activerecord.models.product", count: 1),
                      collab_product_path(f.object.product),
                      data: {turbo_frame: "_top"},
                      class: "text-brand hover:underline"
                    )
                  %>
                </p>
              <% end %>
            </div>
            <%= f.error_text(:barcode) %>
            <%= f.error_text(:product_id) %>
            <%= f.error_text(:product) %>
          </div>
        <% end %>
        <div class="w-full flex flex-wrap justify-between items-center mt-3 gap-4">
          <div class="flex flex-wrap flex-initial items-center gap-4">
            <div>
              <%= f.label(:present_quantity, t("activerecord.attributes.annotation_item.present_quantity"), class: "block text-sm font-medium text-gray-600 whitespace-nowrap") %>
              <div class="mt-1 relative rounded-md shadow-sm">
                <%=
                  f.text_field(:present_quantity, class: "focus:ring-brand focus:border-brand block w-full pr-6 text-sm border-gray-300 rounded-md #{@disabled_classes}", disabled: @disabled, data: {action: "change->annotation-items--form#handleChange focus->annotation#selectItem"})
                %>
                <div class="absolute inset-y-0 right-0 flex items-center">
                  <%= f.label(:present_unit_id, t("activerecord.attributes.annotation_item.present_unit"), class: "sr-only") %>
                  <%= f.collection_select(:present_unit_id, @units, :id, :id, {}, class: "focus:ring-brand focus:border-brand h-full py-0 pr-8 border-transparent bg-transparent text-gray-500 text-sm rounded-md", disabled: @disabled, data: {action: "change->annotation-items--form#handleChange focus->annotation#selectItem"}) %>
                </div>
              </div>
              <%= f.error_text(:present_quantity) %>
              <%= f.error_text(:present_unit_id) %>
            </div>
            <div>
              <%= f.label(:consumed_quantity, t("activerecord.attributes.annotation_item.consumed_quantity"), class: "block text-sm font-medium text-gray-600 whitespace-nowrap") %>
              <div class="flex flex-wrap items-center gap-2">
                <div class="mt-1 relative rounded-md shadow-sm">
                  <%=
                    f.text_field(
                      :consumed_quantity,
                      class: "focus:ring-brand focus:border-brand block w-full pr-6 text-sm border-gray-300 rounded-md #{@disabled_classes}", disabled: @disabled,
                      data: {
                        action: "change->annotation-items--form#handleChange focus->annotation#selectItem"
                      }
                    )
                  %>
                  <div class="absolute inset-y-0 right-0 flex items-center">
                    <%= f.label(:consumed_unit_id, t("activerecord.attributes.annotation_item.consumed_unit"), class: "sr-only") %>
                    <% unit_ids = Array("%") + @units.pluck(:id) %>
                    <%=
                      f.select(
                        :consumed_unit_id,
                        unit_ids,
                        {},
                        class: "focus:ring-brand focus:border-brand h-full py-0 pl-2 pr-8 border-transparent bg-transparent text-gray-500 text-sm rounded-md",
                        disabled: @disabled,
                        data: {
                          action: "change->annotation-items--form#handleChange focus->annotation#selectItem"
                        }
                      )
                    %>
                  </div>
                </div>
                <div class="mt-1 text-gray-600 whitespace-nowrap">
                  <%= @displayed_calculated_consumed_info %>
                </div>
              </div>
              <%= f.error_text(:consumed_quantity) %>
              <%= f.error_text(:consumed_unit_id) %>
            </div>
          </div>
          <% unless @disabled %>
            <div class="flex flex-initial items-center gap-2 2xl:mt-6">
              <div>
                <%=
                  check_box_tag(
                    "annotations_selected_annotation_items[annotation_item_ids]",
                    f.object.id,
                    false,
                    class: "focus:ring-brand focus:border-brand h-4 w-4 text-brand border-gray-300 rounded",
                    data: {
                      action: "change->annotation#toggleButtons"
                    }
                  )
                %>
              </div>
              <%=
                link_to(
                  collab_annotation_item_path(@annotation_item, locale: I18n.locale),
                  title: t("helpers.destroy"),
                  data: {turbo_method: :delete, turbo_confirm: t("helpers.are_you_sure")},
                  class: "pt-2"
                ) do
              %>
                <%= render(IconComponent.new(
                      "trash",
                      classes: "text-contrast-#{@color_index} text-xl hover:text-gray-800"
                    )) %>
              <% end %>
            </div>
          <% end %>
        </div>
        <% if f.object.errors[:consumed_kcal].present? || f.object.disable_kcal_in_range_validation %>
          <div class="flex flex-row justify-start space-x-2 items-center">
            <%= f.error_text(:consumed_kcal) %>
            <%= f.label(:disable_kcal_in_range_validation, class: "mt-2") %>
            <%=
              f.check_box(
                :disable_kcal_in_range_validation,
                class: "focus:ring-brand h-4 w-4 text-brand border-gray-300 rounded mt-2 #{@disabled_classes}",
                disabled: @disabled,
                data: {
                  action: "focus->annotation#selectItem change->annotation-items--form#handleChange"
                }
              )
            %>
          </div>
        <% end %>
        <%= f.error_text(:base) %>
      </div>
    <% end %>
  <% end %>
<% end %>
