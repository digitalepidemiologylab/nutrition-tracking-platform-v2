<div class="py-6">
  <%= render(Collab::TitleComponent.new) do |t| %>
    <%= t(".title") %>
  <% end %>
  <div class="px-4 sm:px-6 md:px-8">
    <div class="pb-6">
      <%= form_with url: "", method: :get, builder: AppFormBuilder, class: "flex justify-between items-center md:justify-end md:space-x-4", data: {controller: "query-form", turbo_frame: "users", turbo_action: "advance"} do |f| %>
        <div>
          <%= f.label :items, t("helpers.items"), class: "text-sm font-medium text-gray-700" %>
          <%= f.select :items, options_for_select([10, 25, 50, 100], selected: params[:items] || Pagy::DEFAULT[:items]), {}, class: "mt-1 w-20 border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand focus:border-brand sm:text-sm border-gray-300", data: {action: "query-form#handleCountChange"} %>
        </div>
        <div>
          <%=
            f.label(
              :query,
              t(".query.label"),
              class: "text-sm font-medium text-gray-700",
              data: {
                "tippy-content": t(".query.tooltip")
              }
            )
          %>
          <%= f.search_field :query, value: params[:query], autofocus: true, class: "mt-1 border rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand focus:border-brand sm:text-sm border-gray-300", data: {action: "query-form#handleSearchChange"} %>
        </div>
      <% end %>
    </div>
    <%= turbo_frame_tag "users" do %>
      <%= render(Collab::TableComponent.new) do |tc| %>
        <% tc.with_head_td(column: :email, params: params) { t("activerecord.attributes.user.email") } %>
        <% tc.with_head_td(column: :id, params: params) { t("activerecord.attributes.user.id") } %>
        <% tc.with_head_td { t("activerecord.attributes.user.cohorts") } %>
        <% tc.with_head_td(column: :created_at, params: params, align: :right) { t("activerecord.attributes.user.created_at") } %>
        <% @users.each do |user| %>
          <% tc.with_row do |r| %>
            <% r.with_row_td(additional_classes: "font-medium text-gray-800") do %>
              <%= link_to_if(user.email, user.email, collab_user_path(user), data: {turbo_frame: "_top"}, class: "text-brand hover:underline") %>
            <% end %>
            <% r.with_row_td(additional_classes: "font-medium text-gray-800") do %>
              <%= link_to(user.id, collab_user_path(user), data: {turbo_frame: "_top"}, class: "text-brand hover:underline") %>
            <% end %>
            <% r.with_row_td(additional_classes: "text-gray-500") do %>
              <ul>
                <% Collab::ParticipationPolicy::Scope.new(current_collaborator, user.participations).resolve.map do |participation| %>
                  <% cohort = participation.cohort %>
                  <li>
                    <%=
                      safe_join([
                        link_to(cohort.name, collab_cohort_path(cohort), data: {turbo_frame: "_top"}, class: "text-brand hover:underline"),
                        tag.span(participation.key, class: "text-gray-400 text-xs ml-1")
                      ])
                    %>
                  </li>
                <% end %>
              </ul>
            <% end %>
            <% r.with_row_td(additional_classes: "text-right text-gray-500") do %>
              <%= l(user.created_at, format: :long) %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
      <%= render(PaginationComponent.new(pagy: @pagy)) %>
    <% end %>
  </div>
</div>
